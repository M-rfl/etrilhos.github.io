<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>eMOBI Grupo CCR</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
        /* General Styling */
        body {
            margin: 0;
            font-family: Arial, sans-serif;
	    overflow: hidden; /* Prevent vertical and horizontal scrollbars */
        }

        /* Header */
        header {
            background-color: #FF7C3C;
            color: white;
            display: flex;
            justify-content: center; /* Center the content horizontally */
            align-items: center; /* Center the content vertically */
            padding: 10px 20px;
            font-size: 1.5em;
            font-weight: bold;
            height: 5vh;
        }

        header .logo {
            height: 40px;
            position: absolute; /* Position the logo separately */
            right: 20px; /* Align logo to the right */
        }

	/* Import Container layout*/
        #importContainer {
            background-color: white;
            color: black;
            display: none;
	    flex-direction: column; /* Ensure content is stacked vertically */
	    align-items: flex-start; /* Align items to the left */
            justify-content: center;
            padding: 10px;
	    box-sizing: border-box;
            font-size: 0.75em;
            font-weight: bold;
	    height: 15vh; /* Adjust height dynamically based on content */
	    width: 100%; /* Make sure it spans the full width */
        }

        /* Tab Navigation */
        #tabNav {
            display: flex;
            background-color: white;
            color: white;
            border-bottom: 2px solid #ccc;
            margin: 0;
            padding: 0;
	    height: 7vh;
        }

        .tab {
        	background-color: #8C8E91;
  			float: left;
  			outline: none;
  			padding: 14px 16px;
  			transition: 0.3s;
            text-align: center;
            cursor: pointer;
            border-right: 1px solid #ccc;
        }

        .tab:last-child {
            border-right: none;
        }

        .tab.active {
            background-color: #FF9D6C;
            font-weight: bold;
        }

        .tab:hover {
            background-color: #8C8E91;
        }

        /* Tab Content */
        .tabContent {
            display: none;
            padding: 3px 3px;
            overflow: auto;
	    height: 100vh;
        }

        .tabContent.active {
            display: block;
        }

        /* Main container layout */
        #mainContainer {
            display: grid;
            grid-template-columns: 30% 70%;
            grid-template-rows: auto 65% 35%;
            gap: 5px;
            height: 82vh;
            padding: 5px;
            box-sizing: border-box;
        }

        /* Individual sections */
        #hierarchyTree {
            grid-column: 1;
            grid-row: 1 / 4;
            border: 1px solid #ccc;
            padding: 5px;
            overflow-y: auto;
            overflow-x: auto;
            font-size: 12px;
            white-space: nowrap;
        }

        #imageContainer {
            grid-column: 2;
            grid-row: 1 / 3;
            border: 1px solid #ccc;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: auto;
            position: relative;
        }

        #componentImage {
            width: 95%;
            height: 95%;
            object-fit: contain;
            image-rendering: high-quality;
            max-width: 100%;
            max-height: 100%;
            transform: scale(1);
            transition: transform 0.3s ease;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            cursor: grab;
        }

        #bottomContainer {
            grid-column: 2;
            grid-row: 3;
            display: grid;
            grid-template-columns: repeat(1, 1fr);
            gap: 5px;
        }

        .bottom-section {
            border: 1px solid #ccc;
            padding: 5px;
            overflow-y: auto;
    	    font-size: 12px;
        }

    	/* Make only the first row in tableContainer bold */
    	#tableContainer table tbody tr:first-child {
        font-weight: bold;
    	}

        /* Zoom controls */
        #zoomControls {
            position: absolute;
            bottom: 10px;
            right: 10px;
            z-index: 10;
        }

        #zoomControls button {
            margin: 5px;
            padding: 5px 10px;
            cursor: pointer;
        }

	#prevImage {
    	display: inline-block !important;
    	visibility: visible !important;
	margin: 1px;
	}

	#nextImage {
    	display: inline-block !important;
    	visibility: visible !important;
	margin: 1px;
	}

	#prevImage:disabled, #nextImage:disabled {
    	opacity: 0.5;
    	cursor: not-allowed;
	}

	#imageInfo {
    	    position: absolute;
    	    bottom: 15px;
    	    left: 3.5%;
    	    transform: translateX(-50%);
    	    background-color: #FF7C3C;
    	    color: white;
    	    padding: 5px 5px;
    	    border-radius: 0px;
    	    font-size: 14px;
    	    z-index: 10;
	}

        /* Tree styling */
        .tree-item {
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 2px 0;
        }

	.tree-item.selected {
    	    background-color: #FFD580; /* Light orange background */
    	    font-weight: bold;
	}

        .toggle-btn {
            min-width: 20px;
            height: 20px;
            line-height: 18px;
            text-align: center;
            border: 1px solid #ccc;
            border-radius: 3px;
            cursor: pointer;
            background: #FF7C3C;
        }

        .toggle-placeholder {
            min-width: 20px;
            height: 20px;
        }

        .view-btn {
            padding: 2px 8px;
            background-color: #004680;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
        }

        /* Tree structure */
        ul {
            list-style-type: none;
            padding-left: 25px;
            margin: 0;
            position: relative;
        }

        ul:before {
            content: '';
            position: absolute;
            top: 0;
            left: 8px;
            bottom: 0;
            width: 1px;
            background: #ccc;
        }

        li {
            margin: 5px 0;
            position: relative;
        }

        li:before {
            content: '';
            position: absolute;
            top: 12px;
            left: -17px;
            width: 17px;
            height: 1px;
            background: #ccc;
        }

        li:last-child:after {
            content: '';
            position: absolute;
            top: 13px;
            left: -17px;
            bottom: 0;
            width: 1px;
            background: white;
        }

        #treeContent > ul:before,
        #treeContent > ul > li:before {
            display: none;
        }

        /* Responsive design */
        @media (max-width: 768px) {
            #mainContainer {
                grid-template-columns: 1fr;
                grid-template-rows: auto auto 1fr;
            }

            #hierarchyTree {
                grid-column: 1;
                grid-row: 1;
                max-height: 300px;
            }

            #imageContainer {
                grid-column: 1;
                grid-row: 2;
            }

            #bottomContainer {
                grid-column: 1;
                grid-row: 3;
                grid-template-columns: 1fr;
            }

	// Seção Pesquisa Material
        body {
            font-family: Arial, sans-serif;
            margin: 0; /* Removed unnecessary margin to prevent layout issues */
	    height: 100vh; /* Ensure body height matches the viewport */
	    overflow: hidden; /* Prevent scrollbars on the body */
        }

	#pesquisaMaterial {
    	    display: flex;
    	    flex-direction: column;
    	    height: 82vh;
    	    padding: 10px;
    	    box-sizing: border-box;
	    overflow: hidden; /* Prevent content overflow beyond the tab */
	}

	.fields-container {
    	    display: flex; /* Use flex for better alignment */
	    flex-wrap: wrap; /* Wrap fields if they exceed width */
    	    gap: 10px;
    	    margin-bottom: 10px; /* Add spacing below the filter controls */
    	    align-items: flex-end; /* Align items at the bottom for consistent positioning */
	}

	.table-container {
    	    flex: 1; /* Fill available space */
    	    overflow-y: auto; /* Allow scrolling if content exceeds available height */
	    overflow-x: hidden; /* Disable horizontal scrolling if unnecessary */
    	    height: 67vh;
	}

        input, button, select {
            padding: 10px;
            margin: 5px 0;
            width: 100%; /* Ensures input and select elements span full width of container */
        }
            
        }
        input[type="file"] {
            padding: 5px;
        }
        button {
            background-color: #FF7C3C;
            color: white;
            border: none;
            cursor: pointer;
        }

	.highlight {
    	    background-color: yellow;
    	    font-weight: bold;
	}
        
	/* Layout for fields */
        .input-container {
            margin-bottom: 15px;
        }

        /* Flexbox container for fields */
        .fields-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
        }
        
	/* Style for each input container */
        .field {
            flex: 1;
            margin-right: 20px;
        }

	/* Ensure the checkbox is aligned properly */
        .checkbox-container {
            flex: 1;
            display: flex;
            align-items: center;
        }
        
	label {
            display: block;
            margin-bottom: 5px; /* Space between label and field */
        }
        
	/* Optional: Add some spacing between rows for better layout */
        .input-container, .checkbox-container {
            width: 100%;
        }

        /* Add a bit of spacing for the checkbox */
        .checkbox-container input {
            margin-right: 10px;
        }

	#resultTable {
    	    width: 100%; /* Make the table width fit the parent container */
    	    border-collapse: collapse; /* Collapse borders for a clean look */
	}	

	#resultTable th, #resultTable td {
    	    text-align: left; /* Align text to the left for better readability */
    	    padding: 8px; /* Add padding for spacing */
	}

	#resultTable thead {
    	    background-color: #f1f1f1; /* Optional: Add a background color for the header */
	}

	#resultTable tbody tr:nth-child(even) {
    	    background-color: #f9f9f9; /* Optional: Add alternating row colors for better visibility */
	}

	#resultTable td:nth-child(4), /* 4th column (Texto Longo) */
	#resultTable th:nth-child(4) {
    	    word-break: break-all	; /* Allow breaking long words */
    	    white-space: normal; /* Enable text wrapping */
	}

	#chat {
	width: 100%;
    	height: 82vh;
	overflow: hidden;
	}

    </style>
<meta content="width=device-width, initial-scale=1" name="viewport"/><style>
/* Mobile Styles */
@media (max-width: 768px) {
    body {
        font-size: 16px;
        line-height: 1.5;
    }
    .container {
        width: 100%;
        padding: 10px;
    }
    .header, .footer {
        text-align: center;
        padding: 10px;
    }
    .tree-view, .table-view {
        width: 100%;
        overflow-x: auto;
    }
    .btn {
        width: 100%;
        padding: 10px;
        margin: 5px 0;
    }
}
</style></head>
<body>
<header>
<div>Catálogo eMOBI: Grupo CCR</div>
<button id="toggleImportContainer" style="background-color: #FF7C3C; color: white; border: none; padding: 5px 5px; cursor: pointer; position: absolute; left: 5px;">
	▼
	</button>
<img alt="CCR Logo" class="logo" src="https://drive.google.com/thumbnail?id=193b63Ypk6G5VCxNIsOfUVFuhgSWvc1ox"/>
</header>
<div id="importContainer">
<!-- First Line -->
<div style="display: flex; align-items: center; gap: 5px;">
<h3 style="margin: 0; text-align: left; flex-shrink: 0; width: 950px;">Importar JSON - Sistema/Equipamento</h3>
<input accept=".json" id="fileInput" style="flex: 1;" type="file"/>
<button onclick="loadSistemaEquipamentoJSON()" style="background-color: #FF7C3C; color: white; border: none; padding: 5px 10px; cursor: pointer;">
		    Carregar
                </button>
</div>
<!-- Second Line -->
<div style="display: flex; align-items: center; gap: 5px;">
<h3 style="margin: 0; text-align: left; flex-shrink: 0; width: 950px;">Importar JSON - Base Cadastro</h3>
<input accept=".json" id="fileInputCadastro" style="flex: 1;" type="file"/>
<button onclick="loadBaseCadastroJSON()" style="background-color: #FF7C3C; color: white; border: none; padding: 5px 10px; cursor: pointer;">
                    Carregar
            	</button>
</div>
</div>
<!-- Tab Navigation -->
<div id="tabNav">
<div class="tab active" onclick="switchTab('montagem')">SISTEMA/EQUIPAMENTO</div>
<div class="tab" onclick="switchTab('pesquisaMaterial')">PESQUISA MATERIAL</div>
<div class="tab" onclick="switchTab('chat')">ASSISTENTE IA</div>
</div>
<!-- Tab Content -->
<div class="tabContent active" id="montagem">
<div id="mainContainer">
<!-- Hierarchy Tree -->
<div id="hierarchyTree">
<div id="treeContent"></div>
</div>
<!-- Image Container -->
<div id="imageContainer">
<div id="imageInfo">0 / 0</div>
<button id="prevImage" inline-block";"="" onclick="navigateImage(-1)" style="position: absolute; left: 1px; top: 50%; transform: translateY(-50%); display: ">❮</button>
<img alt="Component Image" id="componentImage" style="display: none;"/>
<button id="nextImage" inline-block";"="" onclick="navigateImage(1)" style="position: absolute; right: 1px; top: 50%; transform: translateY(-50%); display: ">❯</button>
<div id="zoomControls">
<button onclick="zoomImage(1.1)">+</button>
<button onclick="zoomImage(0.9)">-</button>
<button onclick="resetZoom()">Reset</button>
</div>
</div>
<!-- Bottom Section -->
<div id="bottomContainer">
<div class="bottom-section">
<div style="display: flex; align-items: center; justify-content: space-between;">
<h3>Detalhes da Montagem</h3>
<div id="cadastroInfo"></div>
<button id="exportButton" onclick="exportToExcel()" style="margin-left: 10px; background-color: #FF7C3C; color: white; border: none; padding: 5px 10px; cursor: pointer;">Exportar Excel</button>
</div>
<!-- Space for future table -->
<div id="tableContainer" style="margin-top: -5px; font-size: 0.75em"></div>
</div>
</div>
</div>
</div>
<div class="tabContent" id="pesquisaMaterial">
<!-- Fields Container -->
<div class="fields-container">
<!-- Search Input Field with label above -->
<div class="field input-container">
<label for="searchInput">Pesquisa:</label>
<input disabled="" id="searchInput" placeholder="Palavras-chave..." type="text"/>
<select disabled="" id="searchCondition">
<option value="E">E</option>
<option value="OU">OU</option>
</select>
</div>
<!-- Depósito Dropdown with label above -->
<div class="field input-container">
<label for="depositoFilter">Estoque:</label>
<select disabled="" id="depositoFilter">
<option value="">Filter by Depósito</option>
</select>
</div>
<!-- Utilização Livre Checkbox -->
<div class="checkbox-container input-container">
<label>
<input id="utilizacaoLivreCheckbox" type="checkbox"/> Estoque &gt; 0
                    </label>
</div>
<!-- Filter Button -->
<div class="field input-container">
<button id="filterButton" onclick="filterData()" style="margin: 10px 0; font-weight: bold;">Filtrar</button>
<button id="exportSearchButton" onclick="exportSearchResultsToExcel()" style="margin: 10px 0; font-weight: bold;">Exportar Excel</button>
</div>
<div id="resultCount" style="margin: 10px 0; font-weight: bold;"></div>
</div>
<div class="table-container">
<table id="resultTable">
<thead>
<tr>
<th>Centro</th>
<th>Material</th>
<th>Texto breve de material</th>
<th>Texto Longo</th>
<th>Depósito</th>
<th>Utilização livre</th>
</tr>
</thead>
<tbody>
<!-- Search results will appear here -->
</tbody>
</table>
</div>
</div>
<div class="tabContent" id="chat">
<iframe frameborder="0" src="https://www.chatbase.co/chatbot-iframe/iqF116Gl34OFjEZ7p3zxX" style="height: 100%" width="100%"></iframe>
</div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script>
	const imageMap = {
    	    "2105195": "1pYKOzXkT8cip_vxGeXCgTD9-h1U2mQPY",  // example: material ID → file ID on Drive
	};

	document.addEventListener("DOMContentLoaded", function () {
	    const toggleButton = document.getElementById("toggleImportContainer");
	    const importContainer = document.getElementById("importContainer");
	    const mainContainer = document.getElementById("mainContainer");
	    const pesquisaMaterial = document.getElementById("pesquisaMaterial");
	    const chat = document.getElementById("chat");
	
		toggleButton.addEventListener("click", function () {
    	    	    const isHidden = importContainer.style.display === "none" || importContainer.style.display === "";
	    	    importContainer.style.display = isHidden ? "flex" : "none";
	    	    mainContainer.style.height = isHidden ? "67vh" : "82vh";
	    	    pesquisaMaterial.style.height = isHidden ? "67vh" : "82vh";
		    chat.style.height = isHidden ? "67vh" : "84vh";
	    	    this.textContent = isHidden ? "▲" : "▼"; // Exibir e ocultar seção importar
	    });
    	});

	function generateChildTable(selectedItem) {
	    let tableContainer = document.getElementById("tableContainer"); // Ensure it is not declared twice

    	    if (!selectedItem) {
                tableContainer.innerHTML = "<p>Nenhum item selecionado.</p>";
                return;
    	    }

    	    const rows = [];

	
	    // Add the selected item as the first row
	    rows.push({
		Nome: selectedItem.originalname || "N/A",
		//Descrição: selectedItem.description || "N/A",
		"Id": "" || "N/A",
		"Fornecedor": selectedItem.fabricanteFornecedor || "N/A",
		"Ref. Comercial": selectedItem.referenciaComercial || "N/A",
		"Qtd": selectedItem.qtd || "N/A",
		"Código SAP": selectedItem.codigoSap || "N/A",
		"%Cadastro": selectedItem.cadastro || "N/A",
		Doc: selectedItem.documentation && selectedItem.documentation.trim()
		    ? `<button class="doc-button" onclick="showDocumentation('${selectedItem.description}', '${selectedItem.codigoSap}', '${selectedItem.documentation}', '${selectedItem.originalname}', '${selectedItem.fabricanteFornecedor}', '${selectedItem.referenciaComercial}', '${selectedItem.qtd}')">✓</button>`
		    : ""
	    });

	    // Add the child items after the selected item
    	    if (selectedItem.children && selectedItem.children.length > 0) {
		selectedItem.children.forEach(child => {
        	    rows.push({
            	        Nome: child.originalname || "N/A",
			//Descrição: child.description || "N/A",
			"Id": child.idFigura || "N/A",
			"Fornecedor": child.fabricanteFornecedor || "N/A",
			"Ref. Comercial": child.referenciaComercial || "N/A",
			"Qtd": child.qtd || "N/A",
            	        "Código SAP": child.codigoSap || "N/A",
			"%Cadastro": child.cadastro || "N/A",
			Doc: child.documentation && child.documentation.trim()
			    ? `<button class="doc-button" onclick="showDocumentation('${child.description}', '${child.codigoSap}', '${child.documentation}', '${child.originalname}', '${child.fabricanteFornecedor}', '${child.referenciaComercial}', '${child.qtd}')">✓</button>`
			    : "" // Render as a button if documentation exists
        	    });
    	        });
	    }

    	    // Clear and render the table
	    tableContainer.innerHTML = ""; // Clear previous content
    	    const table = document.createElement("table");
    	    table.style.width = "100%";
    	    table.style.borderCollapse = "collapse";

    	    // Create table headers
    	    const thead = document.createElement("thead");
    	    const headerRow = document.createElement("tr");
    	    Object.keys(rows[0]).forEach(key => {
        	const th = document.createElement("th");
        	th.style.border = "1px solid #ddd";
        	th.style.padding = "8px";
        	th.style.backgroundColor = "#f4f4f4";
        	th.textContent = key;
        	headerRow.appendChild(th);
    	    });
    	    thead.appendChild(headerRow);
    	    table.appendChild(thead);

    	    // Create table rows
    	    const tbody = document.createElement("tbody");
    	    rows.forEach(row => {
        	const tr = document.createElement("tr");
        	Object.entries(row).forEach(([key, value]) => {
            	    const td = document.createElement("td");
            	    td.style.border = "1px solid #ddd";
            	    td.style.padding = "8px";
		    if (key === "Doc") {
			td.innerHTML = value; // Render as HTML for buttons
		    } else {
			td.textContent = value; // Render as plain text
		    }
            	    tr.appendChild(td);
        	});
           	tbody.appendChild(tr);
    	    });
    	    table.appendChild(tbody);

    	    tableContainer.appendChild(table);
	}

	function exportToExcel() {
            if (!hierarchyData || hierarchyData.length === 0) {
                alert("Nenhum dado disponível para exportação.");
            	return;
            }

            // Get the selected tree item
            const selectedTreeItem = document.querySelector('.tree-item.selected');
            if (!selectedTreeItem) {
                alert("Selecione um item na árvore para exportar.");
                return;
            }

            const selectedName = selectedTreeItem.querySelector('.item-originalname').textContent;

            // Find the selected item and its children in the hierarchy data
            function findItem(data, originalname) {
                for (const item of data) {
                    if (item.originalname === originalname) return item;
                    if (item.children && item.children.length > 0) {
                        const result = findItem(item.children, originalname);
                        if (result) return result;
                    }
                }
                return null;
            }

            const selectedItem = findItem(hierarchyData, selectedName);
            if (!selectedItem) {
                alert("Erro ao localizar o item selecionado.");
                return;
            }

            // Collect parent and all descendants' data recursively
            const rows = [];
            function addRow(item, level = 1) {
		const prefix = "   ".repeat(level - 1); // Bullet-style indentation
                rows.push({
                    "Código SAP": item.codigoSap || "N/A",
                    "Texto breve de material": `${prefix}${item.originalname || "N/A"}`,
		    //"Descrição": item.description || "N/A",
		    "Fornecedor": item.fabricanteFornecedor || "N/A",
		    "Ref. Comercial": item.referenciaComercial || "N/A",
		    "Qtd": item.qtd || "N/A"
                });
	    // Recursively add all children with increased level
	    	if (item.children && item.children.length > 0) {
	            item.children.forEach(child => addRow(child, level + 1));
            	};
	    }

            // Add parent item
            addRow(selectedItem);
	    
            // Convert data to a worksheet and create a workbook
            const worksheet = XLSX.utils.json_to_sheet(rows);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, "Dados");

            // Export to XLSX
            const filename = `${selectedName.replace(/\s+/g, "_")}_BOM.xlsx`;
            XLSX.writeFile(workbook, filename);
        }

        function switchTab(tabId) {
            // Deactivate all tabs and contents
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tabContent').forEach(content => content.classList.remove('active'));

            // Activate the clicked tab and its content
            document.querySelector(`.tab[onclick="switchTab('${tabId}')"]`).classList.add('active');
            document.getElementById(tabId).classList.add('active');
        }

        let hierarchyData = [];
        let scale = 1;
        let isDragging = false;
        let startX, startY;
        const componentImage = document.getElementById('componentImage');

        // Load JSON file (SISTEMA/EQUIPAMENTO)
        function loadSistemaEquipamentoJSON() {
            const fileInput = document.getElementById("fileInput");
            const file = fileInput.files[0];

            if (!file) {
                alert("Por favor, selecione um arquivo JSON.");
                return;
            }

            const reader = new FileReader();
            reader.onload = function(event) {
                try {
                    hierarchyData = JSON.parse(event.target.result);
                    generateTree();
                    alert("Sistema/Equipamento JSON carregado com sucesso!");
                } catch (e) {
                    alert("Arquivo JSON inválido.");
                    console.error(e);
                }
            };
            reader.readAsText(file);
        }

        // Image handling functions
        function zoomImage(factor) {
            scale *= factor;
            componentImage.style.transform = `translate(-50%, -50%) scale(${scale})`;
        }

        function resetZoom() {
            scale = 1;
    	    componentImage.style.left = '50%';  // Reset left position to center
     	    componentImage.style.top = '50%';   // Reset top position to center
            componentImage.style.transform = "translate(-50%, -50%) scale(1)";
        }

        // Mouse event handlers for dragging
        componentImage.addEventListener("mousedown", (e) => {
            e.preventDefault();
            isDragging = true;
            startX = e.pageX;
            startY = e.pageY;
        });

        window.addEventListener("mousemove", (e) => {
            if (isDragging) {
                const x = e.pageX - startX;
                const y = e.pageY - startY;
                componentImage.style.left = `calc(50% + ${x}px)`;
                componentImage.style.top = `calc(50% + ${y}px)`;
		componentImage.style.cursor = "grabbing"
            }
        });

        window.addEventListener("mouseup", () => {
            isDragging = false;
            componentImage.style.cursor = "grab";
        });

        // Generate tree structure
        function generateTree() {
            const treeContent = document.getElementById("treeContent");
            treeContent.innerHTML = "";
            treeContent.appendChild(createTree(hierarchyData, true));
        }

        function createTree(data, isRoot = false) {
            const ul = document.createElement("ul");

            data.forEach(item => {
                const li = document.createElement("li");
                const itemContainer = document.createElement("div");
                itemContainer.className = "tree-item";

                if (item.children && item.children.length > 0) {
                    const toggleButton = document.createElement("button");
                    toggleButton.className = "toggle-btn";
                    toggleButton.textContent = "+";
                    toggleButton.onclick = () => {
                        const childrenUl = li.querySelector("ul");
                        if (childrenUl) {
                            const isHidden = childrenUl.style.display === "none";
                            childrenUl.style.display = isHidden ? "block" : "none";
                            toggleButton.textContent = isHidden ? "-" : "+";
                        }
                    };
                    itemContainer.appendChild(toggleButton);
                } else {
                    const placeholder = document.createElement("span");
                    placeholder.className = "toggle-placeholder";
                    itemContainer.appendChild(placeholder);
                }

                const nameSpan = document.createElement("span");
                nameSpan.className = "item-originalname";
                nameSpan.textContent = item.originalname;
                nameSpan.style.cursor = "pointer";
                nameSpan.onclick = function () {
		    highlightSelected(itemContainer); // Highlight the selected item
		    displayDetails(
                    	item.description,
                    	item.codigoSap,
			item.idFigura,
                    	item.documentation,
                    	item.imageUrl1,
                    	item.imageUrl2,
                    	item.imageUrl3,
			item.originalname,
			item.fabricanteFornecedor,
			item.referenciaComercial,
			item.qtd,
			item.cadastro
                    );
		};
                itemContainer.appendChild(nameSpan);

                li.appendChild(itemContainer);

                if (item.children && item.children.length > 0) {
                    const childrenUl = createTree(item.children, false);
                    childrenUl.style.display = "none";
                    li.appendChild(childrenUl);
                }

                ul.appendChild(li);
            });

            return ul;
        }

	function highlightSelected(item) {
    	    // Remove the 'selected' class from all items
    	    const items = document.querySelectorAll('.tree-item');
    	    items.forEach(el => el.classList.remove('selected'));

    	    // Add the 'selected' class to the clicked item
    	    item.classList.add('selected');
	}
	
	let currentImageIndex = 0;
	let imageUrls = []; // Replace this with your actual image URL array

	function updateImageInfo() {
    	    const imageInfo = document.getElementById('imageInfo');
    	    imageInfo.textContent = `${currentImageIndex + 1} / ${imageUrls.length}`;
	}

        function displayDetails(description, codigoSap, idFigura, documentation, imageUrl1, imageUrl2, imageUrl3, originalname, fabricanteFornecedor, referenciaComercial, qtd, cadastro) {

	    const selectedTreeItem = document.querySelector('.tree-item.selected');
	    if (!selectedTreeItem) {
        	console.error("No tree item selected.");
        	return;
    	    }
	
	    const selectedName = selectedTreeItem.querySelector('.item-originalname').textContent;

    	    function findItem(data, originalname) {
        	for (const item of data) {
            	    if (item.originalname === originalname) return item;
            	    if (item.children && item.children.length > 0) {
                	const result = findItem(item.children, originalname);
                	if (result) return result;
            	    }
        	}
        	return null;
    	    }

    	    const selectedItem = findItem(hierarchyData, selectedName);
    	    if (!selectedItem) {
        	console.error("Selected item not found in hierarchy.");
        	return;
    	    }

    	    // Generate and display the table for child data
    	    generateChildTable(selectedItem);

    	    const cadastroInfo = document.getElementById("cadastroInfo");
    	    if (cadastro) {
        	cadastroInfo.textContent = `%Cadastro: ${cadastro}`;
        	cadastroInfo.style.display = "block";
    	    } else {
        	cadastroInfo.style.display = "none";
    	    }

	    imageUrls = [imageUrl1, imageUrl2, imageUrl3].filter(url => url); // Keep only valid URLs
	    currentImageIndex = 0;
	    updateImage();
	}
	

	function showDocumentation(description, codigoSap, documentation, originalname, fabricanteFornecedor, referenciaComercial, qtd) {
	    
	    // Function to convert documentation into clickable links with line breaks
    	    function makeLinksClickable(doc) {
                if (!doc) return "Nenhuma documentação disponível"

    		// Normalize text (handle escaped characters)
    		const decodedDoc = decodeURIComponent(doc);
		
		// Split documentation by semicolon and process each entry
                const entries = doc.split(";").map(entry => entry.trim());

                return entries

		    .map(entry => {
			// Match a description followed by a URL using regex
			const match = entry.match(/^(.+?):\s*(https?:\/\/[^\s]+.*)$/);
			if (match) {
			    const text = match[1].trim(); // Capture the description
			    const url = match[2].trim();  // Capture the URL
			    return `<a href="${url}" target="_blank" style="color: blue; text-decoration: underline;">${text}</a>`;
			}
			return entry; // If no URL, return the entry as is			
		    })
		    .join("<br>"); // Join entries with line breaks
	    }
	   
	    // Create the dark overlay
	    const overlay = document.createElement("div");
    	    overlay.style.position = "fixed";
    	    overlay.style.top = "0";
    	    overlay.style.left = "0";
    	    overlay.style.width = "100%";
    	    overlay.style.height = "100%";
    	    overlay.style.backgroundColor = "rgba(0, 0, 0, 0.5)"; // Semi-transparent black
    	    overlay.style.zIndex = "999";
    	    overlay.onclick = () => document.body.removeChild(overlay); // Close on clicking the overlay

	    // Create table layout for additional details
    	    const tableHtml = `
        	<div>
                    <p><strong>Documentação:</strong><br>${makeLinksClickable(documentation)}</p>
		</div>
    	    `;

	    // Create and display the pop-up
    	    const popUp = document.createElement("div");
    	    popUp.style.position = "fixed";
    	    popUp.style.top = "50%";
    	    popUp.style.left = "50%";
    	    popUp.style.transform = "translate(-50%, -50%)";
    	    popUp.style.zIndex = "1000";
    	    popUp.style.backgroundColor = "white";
    	    popUp.style.padding = "20px";
    	    popUp.style.border = "1px solid #ccc";
    	    popUp.style.boxShadow = "0px 4px 8px rgba(0, 0, 0, 0.2)";
    	    popUp.innerHTML = tableHtml;

    	    // Add a close button
    	    const closeButton = document.createElement("button");
    	    closeButton.textContent = "Fechar";
    	    closeButton.style.marginTop = "10px";
    	    closeButton.style.backgroundColor = "#FF7C3C";
    	    closeButton.style.color = "white";
    	    closeButton.style.border = "none";
    	    closeButton.style.padding = "10px";
    	    closeButton.style.cursor = "pointer";
    	    closeButton.onclick = () => {
		document.body.removeChild(popUp);
		document.body.removeChild(overlay); // Remove the overlay when closing the pop-up
	    };
    	    popUp.appendChild(closeButton);

    	    // Append the overlay and pop-up to the body
	    document.body.appendChild(overlay);
	    document.body.appendChild(popUp);
	}

	function updateImage() {
	    const componentImage = document.getElementById("componentImage");
            const prevButton = document.getElementById("prevImage");
    	    const nextButton = document.getElementById("nextImage");

    	    if (imageUrls.length > 0) {
        	componentImage.style.display = "block";
        	componentImage.src = imageUrls[currentImageIndex];
        	componentImage.onerror = () => {
		    console.error("Image load failed:", imageUrls[currentImageIndex]);
            	    componentImage.style.display = "none";
            	};

        	resetZoom();
		updateImageInfo();
    	    } else {
        	componentImage.style.display = "none";
		document.getElementById('imageInfo').textContent = "0 / 0";
    	    }

    	    // Ensure buttons are always visible
   	    prevButton.style.display = "block";
    	    nextButton.style.display = "block";

	    prevButton.disabled = currentImageIndex <= 0;
	    nextButton.disabled = currentImageIndex >= imageUrls.length - 1;

	}
	
	function navigateImage(direction) {
	    currentImageIndex += direction;
	    updateImage();

	function navigateImage(direction) {
    	    if (direction === "next" && currentImageIndex < imageUrls.length - 1) {
        	currentImageIndex++;
    	    } else if (direction === "prev" && currentImageIndex < 0) {
        	currentImageIndex--;
    	}

    	updateImage(); // Ensure the image and button states are updated
}

	}
        
	// Function to load JSON file (Base Cadastro)
    	function loadBaseCadastroJSON() {
            const fileInputCadastro = document.getElementById('fileInputCadastro');
            const file = fileInputCadastro.files[0];
        
            if (!file) {
            alert('Por favor, selecione um arquivo JSON.');
            return;
            }

            const reader = new FileReader();
            reader.onload = function(event) {
            try {
               	// Parse the loaded JSON
               	const rawData = JSON.parse(event.target.result);
                   
			// Verify the structure matches the expected fields
                	if (Array.isArray(rawData) && rawData.length > 0 && 'Centro' in rawData[0]) {
                    	jsonData = rawData;
                    	document.getElementById('searchInput').disabled = false; // Enable the search input
                    	populateDepósitoFilter(); // Populate the Depósito filter dropdown
                    	alert("Base Cadastro JSON carregado com sucesso!");
                	} else {
                    	throw new Error('Estrutura de JSON inválida.');
                	}
            	} catch (error) {
                	alert('Erro ao carregar JSON. Verifique o arquivo e sua estrutura.');
                	console.error('Error:', error);
            	}
        	};
        	reader.onerror = function() {
            	alert('Erro ao ler o arquivo. Por favor, tente novamente.');
        	};
        	reader.readAsText(file, 'UTF-8'); // Ensure UTF-8 encoding
    	}

    	// Function to populate the Depósito dropdown with unique values sorted from smallest to largest
    	function populateDepósitoFilter() {
        	const depositoSelect = document.getElementById('depositoFilter');
        	const depositoValues = [...new Set(jsonData.map(item => item["Depósito"]))]; // Get unique values from "Depósito"
            
        	// Sort the values numerically (ascending order)
        	depositoValues.sort((a, b) => a - b);

        	// Add options to the dropdown
        	depositoValues.forEach(value => {
            	const option = document.createElement('option');
            	option.value = value;
            	option.textContent = value;
            	depositoSelect.appendChild(option);
                
        	});
        	depositoSelect.disabled = false; // Enable the dropdown
		searchCondition.disabled = false;
            
    	}
        
    	// Function to filter and display the data
    	function filterData() {
    		const input = document.getElementById('searchInput').value.toLowerCase(); // Get input and convert to lowercase
		const searchCondition = document.getElementById('searchCondition').value;
    		const depositoFilter = document.getElementById('depositoFilter').value;
    		const utilizacaoLivreCheckbox = document.getElementById('utilizacaoLivreCheckbox').checked;
    		const tableBody = document.getElementById('resultTable').querySelector('tbody');
		const resultCount = document.getElementById('resultCount');
    		tableBody.innerHTML = ''; // Clear previous results

		if (typeof jsonData === 'undefined' || !jsonData) {
		    alert('Por favor, carregue o JSON primeiro.');
		    return;
		}

 		// Split the input into multiple keywords
    		const keywords = input.split(' ').filter(keyword => keyword.trim() !== ''); // Remove empty spaces
         
        	// Filter JSON data based on all conditions
        	const filteredData = jsonData.filter(item => {
            	    const matchesSearchInput = (searchCondition === 'E')
            		? keywords.every(keyword =>
                	    (item["Texto breve de material"] && item["Texto breve de material"].toLowerCase().includes(keyword)) ||
                	    (item["Texto Longo"] && item["Texto Longo"].toLowerCase().includes(keyword)) ||
                	    (item["Material"] && item["Material"].toString().toLowerCase().includes(keyword)))
            		: keywords.some(keyword =>
                	    (item["Texto breve de material"] && item["Texto breve de material"].toLowerCase().includes(keyword)) ||
                	    (item["Texto Longo"] && item["Texto Longo"].toLowerCase().includes(keyword)) ||
                	    (item["Material"] && item["Material"].toString().toLowerCase().includes(keyword)));

        	    const matchesDepósito = depositoFilter ? item["Depósito"] === depositoFilter : true;
        	    const matchesUtilizacaoLivre = utilizacaoLivreCheckbox ? item["Utilização livre"] > 0 : true;
        	    return matchesSearchInput && matchesDepósito && matchesUtilizacaoLivre;
                
        	});
            
		// Function to highlight matching keywords in text
		const highlightMatch = (text, keywords) => {
    		    if (!text) return ''; // Handle cases where text is null or undefined
    		    let regex = new RegExp(`(${keywords.join('|')})`, 'gi'); // Create a regex for all keywords
    		    return text.replace(regex, '<span class="highlight">$1</span>'); // Wrap matches in a span
		};


		// Display filtered results
		filteredData.forEach(item => {
		    const materialId = item["Material"];
		    const hasImage = imageMap.hasOwnProperty(materialId);
		    const imageLink = hasImage
			? `<span onclick="showMaterialImage('${materialId}')" title="Visualizar imagem" style="color: blue; text-decoration: underline; cursor: pointer;">${materialId}</span>`
			: materialId;
		
		    const highlightedMaterial = highlightMatch(item["Texto breve de material"], keywords);
		    const highlightedLongText = highlightMatch(item["Texto Longo"], keywords);

            	    const row = `
                	<tr>
                    	    <td>${item["Centro"]}</td>
                    	    <td>${imageLink}</td>
                    	    <td>${highlightedMaterial}</td> <!-- Use the highlighted text here -->
                    	    <td>${highlightedLongText}</td> <!-- Use the highlighted text here -->
                    	    <td>${item["Depósito"] !== null ? item["Depósito"] : 'N/A'}</td>
                    	    <td>${item["Utilização livre"] !== null ? item["Utilização livre"] : 'N/A'}</td>
                	</tr>`;    
		    tableBody.insertAdjacentHTML('beforeend', row);
        	});

		// Update result count
    		resultCount.textContent = `Total: ${filteredData.length}`;
    	}

	function showMaterialImage(materialId) {
	    const fileId = imageMap[materialId];
    	    if (!fileId) {
        	alert("Imagem não encontrada para este material.");
            	return;
    	    }

	    const imageUrl = `https://drive.google.com/thumbnail?id=${fileId}`;

	    const overlay = document.createElement("div");
    	    overlay.style.position = "fixed";
    	    overlay.style.top = "0";
    	    overlay.style.left = "0";
    	    overlay.style.width = "100%";
    	    overlay.style.height = "100%";
    	    overlay.style.backgroundColor = "rgba(0,0,0,0.7)";
    	    overlay.style.zIndex = 1000;
    	    overlay.onclick = () => document.body.removeChild(overlay);

    	    const img = document.createElement("img");
    	    img.src = imageUrl;
    	    img.style.maxWidth = "90%";
    	    img.style.maxHeight = "90%";
    	    img.style.position = "absolute";
    	    img.style.top = "50%";
    	    img.style.left = "50%";
    	    img.style.transform = "translate(-50%, -50%)";
    	    img.style.border = "5px solid white";
    	    img.style.boxShadow = "0 0 20px black";

    	    overlay.appendChild(img);
    	    document.body.appendChild(overlay); 
	
    	}

	function exportSearchResultsToExcel() {
    	    const tableBody = document.getElementById('resultTable').querySelector('tbody');
    	    const rows = Array.from(tableBody.querySelectorAll('tr'));

    	    if (rows.length === 0) {
        	alert("Nenhum resultado disponível para exportação.");
        	return;
    	    }

    	    const data = [];
    	    rows.forEach(row => {
        	const cells = row.querySelectorAll('td');
        	const rowData = {
            	    Centro: cells[0].textContent,
            	    Material: cells[1].textContent,
            	    'Texto breve de material': cells[2].textContent,
            	    'Texto Longo': cells[3].textContent,
            	    Depósito: cells[4].textContent,
            	    'Utilização livre': cells[5].textContent,
        	};
        	data.push(rowData);
    	    });

    	    const worksheet = XLSX.utils.json_to_sheet(data);
    	    const workbook = XLSX.utils.book_new();
    	    XLSX.utils.book_append_sheet(workbook, worksheet, 'Resultados de Pesquisa');

    	    const filename = `Resultados_Pesquisa_${new Date().toISOString().slice(0, 10)}.xlsx`;
    	    XLSX.writeFile(workbook, filename);

	    const imageMap = {
    		"2105195": "1pYKOzXkT8cip_vxGeXCgTD9-h1U2mQPY",
	    };
	}

    </script>
</body>
</html>